# ✅ AI 对话系统 · 业务场景逻辑流程（验收标准版）

> **文档用途**
> * 验证系统是否“真的按设计在跑”
> * 验证 Stage / Persona / 知识库 / AI 配置是否真实生效
> * 非代码视角，但 **可直接映射到代码与日志**

---

## 一、系统整体业务运行逻辑（总览）

**系统不是“聊天机器人”，而是一个“流程驱动引擎”**

### 正确的整体执行顺序（必须一致）

```
【1】用户发送消息
      ↓
【2】系统加载会话状态（Conversation State）
      ↓
【3】Supervisor 分析输入 & 当前状态
      ↓
【4】确定当前 Stage（是否推进）
      ↓
【5】选择 Persona（沟通风格）
      ↓
【6】匹配 Stage 剧本（Script）
      ↓
【7】从知识库中检索【当前 Stage 可用内容】
      ↓
【8】系统选择对应的 AI 配置（自动）
      ↓
【9】AI 生成回复（受 Stage + Persona + KB 约束）
      ↓
【10】风格守卫 / 审核 / 关键词过滤
      ↓
【11】回复用户
      ↓
【12】更新会话状态（Stage / Slots / 日志）
```

👉 **任何一步缺失，都属于“逻辑未按设计执行”**

---

## 二、单轮对话【必须发生的系统行为】（验收点）

当用户发来 **任意一条消息**，系统必须做到：

### ✔ 必须行为（Checklist）

* [ ] 加载该用户的 `conversation_state`
* [ ] Supervisor 被调用（必须有日志）
* [ ] Supervisor 输出结构化决策（JSON）
* [ ] 决策中包含：
  * 当前 Stage
  * 是否推进 Stage
  * Persona
  * agent_profile / AI 配置标识
* [ ] 回复不是直接走默认模型

👉 **验证方式**：
查看日志 / routing_decisions / message_events

---

## 三、Stage（沟通阶段）逻辑验证

### 1️⃣ Stage 的核心职责（必须成立）

Stage 只决定一件事：

> **“现在该聊什么”**

### Stage 必须具备以下特性

* [ ] 同一用户多轮对话，Stage 不会重置
* [ ] Stage 只有在 Supervisor 判断完成条件满足时才推进
* [ ] 用户强烈跳跃式输入时，允许跨 Stage
* [ ] Stage 变化必须写入 DB

### 验收测试示例

**测试用例 A：**

1. 用户进入 S1
2. 连续 3 轮未给出关键信息
   → Stage 仍停留在 S1

**测试用例 B：**

1. 用户在 S1 突然表达明确意向
   → Stage 可直接跳到 S3 / S4

---

## 四、Persona（人设 / 沟通风格）逻辑验证

### Persona 的定位（必须正确）

> Persona 决定 **“怎么说”**，不决定说什么

### Persona 必须满足

* [ ] Persona 不影响 Stage 判定
* [ ] Persona 可在同一 Stage 内切换
* [ ] Persona 参数真实影响生成风格（语气/节奏）
* [ ] Supervisor 可自动选，也可被人工强制覆盖

### 验收方式

* 对同一输入，切换 Persona
* 验证回复风格明显不同，但业务内容一致

---

## 五、知识库 / 话术引用逻辑（核心验收点）

### 知识库的系统地位（必须成立）

> **知识库 = 真实业务内容来源**

AI **不能脱离知识库自由发挥**。

---

### 正确的知识库调用规则

* [ ] 知识库内容必须绑定 Stage
* [ ] AI 只能引用【当前 Stage 可用】的 KB 内容
* [ ] 不同 Stage，KB 命中内容明显不同
* [ ] 未命中 KB 时，有兜底策略（泛化/转人工）

---

### Stage × 知识库引用标准

| Stage | 允许引用的知识库类型 |
| :--- | :--- |
| S0 | 欢迎语 / 基础介绍 |
| S1 | 需求引导 / 问题话术 |
| S2 | 核心方案 / 产品内容 |
| S3 | 异议处理 / 风险说明 |
| S4 | 行动指引 / 流程说明 |
| S5 | 交付说明 / 对接信息 |

👉 **验收重点**：
S0 / S1 不应出现 S2/S3 的深度内容

---

## 六、AI 配置（Agent Profile）逻辑验证

### 正确定位（必须成立）

> AI 配置 **不是用户配置项**，而是系统自动调度结果

---

### 系统必须做到

* [ ] 不同 Stage 使用不同 AI 配置
* [ ] 同一 Stage，不同 Persona 可使用不同参数
* [ ] Supervisor 决策中能看到 agent_profile_id
* [ ] 实际调用的模型与决策一致

### 验收方式

* 查看 message_events / routing log 中的：
  * stage
  * model
  * temperature
* 确认随 Stage 变化而变化

---

## 七、Supervisor（监管决策）逻辑验证

### Supervisor 的唯一职责

> **判断现在该怎么继续，而不是说话**

---

### Supervisor 必须做到

* [ ] 每轮必调用
* [ ] 输出结构化决策
* [ ] 不直接生成用户回复
* [ ] 支持人工强制覆盖
* [ ] 决策可回放、可复现

---

## 八、异常与兜底逻辑（防翻车）

系统必须在以下情况下稳定运行：

* [ ] 知识库无匹配 → 使用兜底话术
* [ ] AI 超时 → fallback 回复
* [ ] 审核未通过 → 安全替代回复
* [ ] 人工接管后 → AI 停止自动回复

---

## 九、最终验收结论标准（你可以直接用）

> **当且仅当以下条件全部满足，可判定系统“按设计逻辑执行”：**

* Stage 能跨轮保持并推进
* Persona 真实影响表达
* 知识库按 Stage 被引用
* AI 配置随 Stage 自动切换
* Supervisor 决策真实驱动回复
* 所有决策可追溯

---

## 十、给研发的一句话说明

> **“请逐条对照这份《业务场景逻辑流程》，验证系统日志与实际行为是否一致。任何一步缺失或走捷径，视为未按设计执行。”**
