# 📤 Telegram 群发工具使用说明

## ⚠️ 重要警告

**使用本工具前，请务必了解以下风险：**

1. 🚫 **封号风险**：频繁群发可能导致账号被 Telegram 限制或永久封禁
2. ⏰ **限流机制**：触发 FloodWait 后需要等待数小时甚至 24 小时
3. 🔍 **检测机制**：Telegram 有反垃圾信息系统，请勿滥用
4. ⚖️ **法律责任**：请勿用于垃圾信息、诈骗或其他违法用途

**建议：先用 3-5 个对话测试，观察 24 小时后再扩大范围**

---

## 🎯 功能特点

### ✅ 核心功能
- 基于 Telegram 聊天分组（Chat Folders）群发
- 复用 `main.py` 的登录 session，无需重复登录
- 支持多行消息输入
- 实时进度显示

### 🛡️ 防封禁机制
- **随机延迟**：每条消息间隔 5-15 秒（随机）
- **限流处理**：自动检测 FloodWait 错误并暂停
- **PeerFlood 保护**：检测到刷屏限制时提示停止
- **异常恢复**：失败时自动记录并继续

---

## 📋 使用步骤

### 1. 运行脚本

```bash
python broadcast.py
```

### 2. 选择分组

程序会列出所有聊天分组：
```
找到 3 个分组：

  [1] 工作群
  [2] 朋友圈
  [3] 客户群

请输入要群发的分组序号 (输入 0 取消):
```

输入序号（例如：`2`）选择目标分组。

### 3. 预览目标

程序会显示该分组中的对话：
```
✅ 找到 15 个对话

📋 预览前 5 个目标：
  1. 张三
  2. 李四
  3. 技术交流群
  4. 王五
  5. 产品讨论组
  ... 还有 10 个
```

### 4. 输入消息

按提示输入消息内容，支持多行：
```
请输入要群发的消息内容（输入完成后按回车，再输入单独一行的 'END' 结束）：
==============================================================
大家好！
这是一条测试消息。

详情请查看：https://example.com
END
```

### 5. 确认发送

程序会显示消息预览：
```
📝 消息预览：
--------------------------------------------------------------
大家好！
这是一条测试消息。

详情请查看：https://example.com
--------------------------------------------------------------
将发送到 15 个对话
==============================================================

⚠️ 确认发送？(输入 YES 确认):
```

输入 `YES` 确认发送。

### 6. 等待完成

程序会显示实时进度：
```
📤 开始群发任务
目标数量: 15
预计耗时: 2.5 分钟（平均 10 秒/条）
==============================================================

[1/15] 正在发送到: 张三 ... ✅ 成功
   ⏳ 等待 8.3 秒...
[2/15] 正在发送到: 李四 ... ✅ 成功
   ⏳ 等待 12.7 秒...
...
```

### 7. 查看结果

任务完成后显示统计：
```
📊 群发任务完成
✅ 成功: 14
❌ 失败: 1
📈 成功率: 93.3%
```

---

## 🔧 技术细节

### 环境复用
- ✅ 读取 `.env` 文件获取 API 凭证
- ✅ 使用 `userbot_session.session` 文件（与 main.py 共享）
- ✅ 无需重复登录验证

### 防封禁策略
```python
# 随机延迟 5-15 秒
delay = random.uniform(5, 15)
await asyncio.sleep(delay)

# FloodWait 自动处理
except FloodWaitError as e:
    wait_time = e.seconds
    await asyncio.sleep(wait_time)

# PeerFlood 警告
except PeerFloodError:
    # 提示用户停止任务
```

### 异常处理
- ✅ `FloodWaitError`：自动等待指定时间后重试
- ✅ `PeerFloodError`：提示用户账号被限制，建议停止
- ✅ 其他异常：记录失败并继续下一个

---

## 📊 示例场景

### 场景 1：小规模测试（推荐）
```
选择分组：[1] 测试群（5个对话）
消息内容：测试消息，请忽略
发送结果：5/5 成功
```

### 场景 2：客户通知
```
选择分组：[3] 客户群（50个对话）
消息内容：各位客户，新版本已上线...
发送结果：48/50 成功（预计耗时 8-10 分钟）
```

### 场景 3：遇到限流
```
[15/50] 正在发送到: 某用户 ... ⚠️ 触发限流！需要等待 3600 秒
   暂停时间: 14:30:15
   （自动等待 1 小时后继续）
```

---

## ⚠️ 常见问题

### Q1: 为什么触发了 FloodWait？
**A:** Telegram 检测到短时间内发送了大量消息。程序会自动等待，无需担心。

### Q2: 什么是 PeerFlood？
**A:** 更严重的限制，表示账号被临时封禁发送消息功能。建议立即停止群发，等待 24 小时。

### Q3: 如何降低封号风险？
**A:** 
- 每天发送不超过 30-50 条
- 分批发送，每批间隔 2-4 小时
- 消息内容不要完全相同
- 避免短时间内加入大量群组

### Q4: 可以发送图片吗？
**A:** 当前版本仅支持文本消息。如需发送图片，可以自行修改代码：
```python
await client.send_file(dialog.entity, 'image.jpg', caption=message)
```

### Q5: 能否保存进度？
**A:** 当前版本不保存进度。如果任务中断，需要重新开始。可以考虑添加断点续传功能。

---

## 🔒 安全建议

1. **不要分享 .env 文件**：包含敏感的 API 凭证
2. **不要分享 session 文件**：包含登录凭证
3. **定期备份账号**：防止封号导致数据丢失
4. **遵守当地法律**：不要用于违法用途

---

## 📝 许可声明

本工具仅供学习和合法用途使用。使用本工具造成的任何后果由使用者自行承担。

---

**祝使用愉快！有问题请查阅 Telegram 官方文档或社区支持。** 🎉


