#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
å¤šå¹³å°ç¤¾äº¤åª’ä½“ AI Bot - ç»Ÿä¸€ç®¡ç†åå°
æ”¯æŒ Telegram, WhatsApp, Facebook, Messenger, å¾®ä¿¡ç­‰
"""

import streamlit as st
import os
import sys
import json
import re
from datetime import datetime
from admin import render_login_panel
import asyncio

# é¡µé¢é…ç½®
st.set_page_config(
    page_title="ğŸ‘‘é¼ç››ğŸ‘‘å†…éƒ¨å·¥å…·",
    page_icon="ğŸ‘‘",
    layout="wide",
    initial_sidebar_state="expanded"
)

# CSS æ ·å¼ï¼ˆä¼˜åŒ–ç´§å‡‘ç‰ˆï¼‰
st.markdown("""
<style>
    .main-header {
        font-size: 2.5rem;
        font-weight: bold;
        text-align: center;
        background: linear-gradient(120deg, #1f77b4, #ff7f0e);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 1.5rem;
    }
    .platform-card {
        padding: 1rem;
        border-radius: 8px;
        border: 2px solid #e0e0e0;
        margin: 0.3rem 0;
        transition: all 0.3s;
    }
    .platform-card:hover {
        border-color: #1f77b4;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .platform-active {
        border-color: #1f77b4 !important;
        background-color: #f0f8ff;
    }
    .status-badge {
        display: inline-block;
        padding: 0.2rem 0.5rem;
        border-radius: 10px;
        font-size: 0.75rem;
        font-weight: bold;
    }
    .status-running {
        background-color: #d4edda;
        color: #155724;
    }
    .status-stopped {
        background-color: #f8d7da;
        color: #721c24;
    }
    .status-pending {
        background-color: #fff3cd;
        color: #856404;
    }
    /* ç´§å‡‘ä¾§è¾¹æ æ ·å¼ */
    [data-testid="stSidebar"] {
        padding-top: 2rem;
    }
    [data-testid="stSidebar"] .element-container {
        margin-bottom: 0.3rem;
    }
    [data-testid="stSidebar"] button {
        padding: 0.3rem 0.5rem;
        font-size: 0.85rem;
    }
    [data-testid="stSidebar"] small {
        font-size: 0.85rem;
    }
</style>
""", unsafe_allow_html=True)

# å¹³å°é…ç½®
PLATFORMS = {
    'telegram': {
        'name': 'Telegram',
        'icon': 'ğŸ“±',
        'color': '#0088cc',
        'status': 'available',  # available, unavailable, coming_soon
        'description': 'å…¨åŠŸèƒ½æ”¯æŒ - ç§èŠ/ç¾¤èŠ/é¢‘é“'
    },
    'whatsapp': {
        'name': 'WhatsApp',
        'icon': 'ğŸ’¬',
        'color': '#25D366',
        'status': 'available',
        'description': 'âœ… å¯ç”¨ - ç§èŠ/ç¾¤èŠè‡ªåŠ¨å›å¤'
    },
    'facebook': {
        'name': 'Facebook',
        'icon': 'ğŸ“˜',
        'color': '#1877f2',
        'status': 'coming_soon',
        'description': 'è§„åˆ’ä¸­ - Messenger + ä¸»é¡µ'
    },
    'messenger': {
        'name': 'Messenger',
        'icon': 'ğŸ’™',
        'color': '#006aff',
        'status': 'coming_soon',
        'description': 'è§„åˆ’ä¸­ - ç‹¬ç«‹å®¢æˆ·ç«¯'
    },
    'wechat': {
        'name': 'å¾®ä¿¡ WeChat',
        'icon': 'ğŸ’š',
        'color': '#07c160',
        'status': 'coming_soon',
        'description': 'è§„åˆ’ä¸­ - ä¸ªäººå·/å…¬ä¼—å·'
    },
    'instagram': {
        'name': 'Instagram',
        'icon': 'ğŸ“·',
        'color': '#E4405F',
        'status': 'coming_soon',
        'description': 'è§„åˆ’ä¸­ - DM è‡ªåŠ¨å›å¤'
    },
    'twitter': {
        'name': 'Twitter/X',
        'icon': 'ğŸ¦',
        'color': '#1DA1F2',
        'status': 'coming_soon',
        'description': 'è§„åˆ’ä¸­ - DM + æåŠå›å¤'
    },
    'discord': {
        'name': 'Discord',
        'icon': 'ğŸ’œ',
        'color': '#5865F2',
        'status': 'coming_soon',
        'description': 'è§„åˆ’ä¸­ - æœåŠ¡å™¨ Bot'
    }
}

TG_GROUP_CACHE_FILE = "platforms/telegram/group_cache.json"
TG_SELECTED_GROUPS_FILE = "platforms/telegram/selected_groups.json"

def load_platform_config(platform):
    """åŠ è½½å¹³å°é…ç½®"""
    config_file = f"platforms/{platform}/config.json"
    try:
        if os.path.exists(config_file):
            with open(config_file, 'r', encoding='utf-8') as f:
                return json.load(f)
    except:
        pass
    return {}

def save_platform_config(platform, config):
    """ä¿å­˜å¹³å°é…ç½®"""
    config_file = f"platforms/{platform}/config.json"
    os.makedirs(os.path.dirname(config_file), exist_ok=True)
    with open(config_file, 'w', encoding='utf-8') as f:
        json.dump(config, f, indent=2, ensure_ascii=False)


def load_tg_group_cache():
    try:
        with open(TG_GROUP_CACHE_FILE, 'r', encoding='utf-8') as f:
            data = json.load(f)
            if isinstance(data, dict):
                return data
    except:
        pass
    return {}


def load_tg_selected_groups():
    try:
        with open(TG_SELECTED_GROUPS_FILE, 'r', encoding='utf-8') as f:
            data = json.load(f)
            return data.get('selected_ids', [])
    except:
        return []


def save_tg_selected_groups(selected_ids):
    os.makedirs(os.path.dirname(TG_SELECTED_GROUPS_FILE), exist_ok=True)
    with open(TG_SELECTED_GROUPS_FILE, 'w', encoding='utf-8') as f:
        json.dump({'selected_ids': selected_ids}, f, ensure_ascii=False, indent=2)


def parse_group_ids(raw_text):
    if not raw_text:
        return []
    entries = re.split(r'[,\s]+', raw_text.strip())
    ids = []
    for token in entries:
        if not token:
            continue
        try:
            ids.append(int(token))
        except:
            continue
    return ids

def render_platform_selector():
    """æ¸²æŸ“å¹³å°é€‰æ‹©å™¨ï¼ˆä¼˜åŒ–ç´§å‡‘ç‰ˆï¼‰"""
    st.sidebar.markdown("### ğŸŒ å¹³å°")
    
    selected_platform = st.session_state.get('selected_platform', 'telegram')
    
    for platform_id, platform_info in PLATFORMS.items():
        # åˆ›å»ºç´§å‡‘çš„å¹³å°é€‰é¡¹
        col1, col2, col3 = st.sidebar.columns([1, 3, 1])
        
        with col1:
            st.markdown(f"<div style='font-size: 1.5rem;'>{platform_info['icon']}</div>", 
                      unsafe_allow_html=True)
        
        with col2:
            st.markdown(f"<small>**{platform_info['name']}**</small>", 
                      unsafe_allow_html=True)
        
        with col3:
            # çŠ¶æ€æ ‡è¯†ï¼ˆç®€åŒ–ç‰ˆï¼‰
            if platform_info['status'] == 'available':
                st.markdown("ğŸŸ¢", unsafe_allow_html=True)
            elif platform_info['status'] == 'coming_soon':
                st.markdown("ğŸŸ¡", unsafe_allow_html=True)
            else:
                st.markdown("ğŸ”´", unsafe_allow_html=True)
        
        # é€‰æ‹©æŒ‰é’®ï¼ˆç´§å‡‘ç‰ˆï¼‰
        button_label = "âœ“" if selected_platform == platform_id else "é€‰æ‹©"
        if st.sidebar.button(
            button_label,
            key=f"select_{platform_id}",
            disabled=(platform_info['status'] != 'available'),
            use_container_width=True,
            type="primary" if selected_platform == platform_id else "secondary"
        ):
            st.session_state.selected_platform = platform_id
            st.rerun()
    
    return selected_platform

def render_telegram_panel():
    """æ¸²æŸ“ Telegram æ§åˆ¶é¢æ¿"""
    from admin import (
        get_bot_status, start_bot, stop_bot, 
        read_file, write_file, read_logs
    )
    
    st.header("ğŸ“± Telegram AI Bot æ§åˆ¶é¢æ¿")
    
    # çŠ¶æ€æ˜¾ç¤º
    col1, col2, col3 = st.columns(3)
    
    with col1:
        is_running, pid = get_bot_status()
        if is_running:
            st.success(f"ğŸŸ¢ è¿è¡Œä¸­ (PID: {pid})")
        else:
            st.error("ğŸ”´ å·²åœæ­¢")
    
    with col2:
        if os.path.exists("userbot_session.session"):
            st.success("âœ… å·²ç™»å½•")
        else:
            st.warning("âš ï¸ æœªç™»å½•")
            if st.button("\u672a\u767b\u5f55 Telegram (\u70b9\u51fb\u767b\u5f55)"):
                st.session_state.show_login_panel = True
    
    with col3:
        if os.path.exists(".env"):
            st.success("âœ… å·²é…ç½®")
        else:
            st.error("âŒ æœªé…ç½®")
    
    st.divider()
    with st.expander("Telegram \u767b\u5f55", expanded=st.session_state.get('show_login_panel', False)):
        render_login_panel()
    
    # æ§åˆ¶æŒ‰é’®
    col1, col2, col3 = st.columns(3)
    
    with col1:
        if st.button("ğŸš€ å¯åŠ¨æœºå™¨äºº", use_container_width=True, type="primary", 
                    disabled=is_running):
            success, message = start_bot()
            if success:
                st.success(message)
                st.rerun()
            else:
                st.error(message)
    
    with col2:
        if st.button("â›” åœæ­¢æœºå™¨äºº", use_container_width=True, 
                    disabled=not is_running):
            success, message = stop_bot()
            if success:
                st.success(message)
                st.rerun()
            else:
                st.error(message)
    
    with col3:
        if st.button("ğŸ”„ é‡å¯æœºå™¨äºº", use_container_width=True,
                    disabled=not is_running):
            stop_bot()
            import time
            time.sleep(1)
            start_bot()
            st.success("æœºå™¨äººå·²é‡å¯")
            st.rerun()
    
    st.divider()
    
    # Tab ç•Œé¢
    tabs = ["ğŸ§  é…ç½®", "ğŸ“¢ ç¾¤å‘", "ğŸ“œ æ—¥å¿—", "ğŸ“Š ç»Ÿè®¡"]
    tab_choice = st.radio("åŠŸèƒ½", tabs, horizontal=True, key='tg_panel_tab')
    if tab_choice == tabs[0]:
        render_telegram_config()
    elif tab_choice == tabs[1]:
        render_telegram_broadcast()
    elif tab_choice == tabs[2]:
        render_telegram_logs()
    else:
        render_telegram_stats()

def render_telegram_config():
    """Telegram é…ç½®ç•Œé¢"""
    from admin import read_file, write_file
    
    st.subheader("âš™ï¸ é…ç½®ç®¡ç†")
    
    col1, col2 = st.columns(2)
    
    with col1:
        st.markdown("**AI äººè®¾**")
        prompt = st.text_area(
            "ç¼–è¾‘æç¤ºè¯",
            value=read_file("prompt.txt"),
            height=200,
            key="tg_prompt"
        )
        if st.button("ğŸ’¾ ä¿å­˜äººè®¾", key="save_prompt"):
            write_file("prompt.txt", prompt)
            st.success("âœ… å·²ä¿å­˜")
    
    with col2:
        st.markdown("**è§¦å‘å…³é”®è¯**")
        keywords = st.text_area(
            "æ¯è¡Œä¸€ä¸ª",
            value=read_file("keywords.txt", "å¸®æˆ‘\næ±‚åŠ©\nAI"),
            height=200,
            key="tg_keywords",
        )
        if st.button("ğŸ’¾ ä¿å­˜å…³é”®è¯", key="save_keywords"):
            write_file("keywords.txt", keywords)
            st.success("âœ… å·²ä¿å­˜")

    st.subheader("QAé…ç½®")
    qa_content = read_file("platforms/telegram/qa.txt", "# Q&A format: question||answer\n# Example: price||Our price is ...\n")
    qa_text = st.text_area("QAé—®é¢˜åº“ï¼ˆæ”¯æŒ Q:/A: æˆ– question||answerï¼‰", value=qa_content, height=220, key="tg_qa")
    if st.button("ğŸ’¾ ä¿å­˜QA", use_container_width=True, key="save_qa"):
        success, message = write_file("platforms/telegram/qa.txt", qa_text)
        if success:
            st.success("âœ… å·²ä¿å­˜QA")
        else:
            st.error("âŒ ä¿å­˜å¤±è´¥")
    st.divider()
    
