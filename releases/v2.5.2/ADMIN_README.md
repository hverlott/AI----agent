# 🎛️ Telegram AI 中控台使用说明

## 📖 简介

`admin_multi.py` 是 SaaS 版本的 Web 管理后台，基于 **Streamlit** 构建，支持多租户、多账号管理。

仓库地址： https://github.com/hverlott/AI----agent

**核心优势 (v2.5.1)：**
- ✅ **多租户隔离**: 数据与配置完全独立
- ✅ **多账号管理**: 一键切换不同账号
- ✅ 无需命令行操作
- ✅ 实时配置更新
- ✅ 图形化群发功能
- ✅ 运行日志监控

---

## 🚀 快速开始

### 1. 安装依赖

确保已安装所有必需的包：

```bash
pip install -r requirements.txt
```

### 2. 启动管理后台

```bash
streamlit run admin_multi.py
```

程序会自动打开浏览器，默认地址：`http://localhost:8501`

### 3. 首次使用

1. 系统会自动初始化租户目录结构。
2. 初始状态下配置为空，请在“平台配置”中添加配置。
3. 在后台点击"启动机器人"按钮。

---

## 🎨 界面功能详解

### 📊 侧边栏 - 控制面板

#### 状态显示
```
🟢 运行中 (PID: 12345)  ← 机器人正在运行
🔴 已停止              ← 机器人未运行
```

#### 控制按钮
- **🚀 启动**：启动 `main.py` 机器人进程
  - 后台运行，不会阻塞界面
  - 日志自动重定向到 `bot.log`
  - PID 保存到 `bot.pid`

- **⛔ 停止**：优雅地停止机器人进程
  - 发送 SIGTERM 信号
  - 清理 PID 文件
  - 保留日志文件

#### 系统信息
```
📊 系统信息
项目路径: D:\AI Talk
Python: 3.11.0
✅ .env 配置完成
✅ Telegram 已登录
```

---

### Tab 1: 🧠 话术配置

#### 左侧：AI 人设 (Prompt)
```
🎭 AI 人设 (Prompt)
┌─────────────────────────────────┐
│ 你是一个幽默、专业的个人助理。    │
│ 请用简短、礼貌的语气回复。       │
│ ...                             │
└─────────────────────────────────┘
        [💾 保存人设]
```

**功能：**
- 实时编辑 `prompt.txt`
- 支持多行文本
- 保存后立即生效（无需重启）

#### 右侧：触发关键词 (Keywords)
```
🔑 触发关键词 (Keywords)
┌─────────────────────────────────┐
│ 帮我                            │
│ 求助                            │
│ AI                              │
│ 机器人                          │
└─────────────────────────────────┘
        [💾 保存关键词]
```

**功能：**
- 编辑 `keywords.txt`
- 每行一个关键词
- 用于群聊触发回复

---

### Tab 2: 📢 消息群发

⚠️ **使用前必读**：群发有封号风险，建议小批量测试！

#### 步骤 1：加载分组
```
1️⃣ 选择目标分组                [🔄 加载分组]
```

点击"加载分组"按钮，程序会：
1. 连接 Telegram 账户
2. 获取所有 Chat Folders（聊天分组）
3. 显示分组列表供选择

#### 步骤 2：选择分组并预览
```
选择分组: [工作群 ▼]
              [📋 预览对话列表]

✅ 找到 15 个对话
▼ 查看目标列表
  1. 张三
  2. 李四
  3. 技术交流群
  ... 还有 12 个
```

#### 步骤 3：输入消息
```
2️⃣ 输入消息内容
┌─────────────────────────────────┐
│ 大家好！                         │
│ 这是一条通知消息...             │
└─────────────────────────────────┘
```

#### 步骤 4：开始群发
```
3️⃣ 开始群发
准备发送到 15 个对话        [🚀 开始群发]

━━━━━━━━━━━━━━━ 60% ━━━━━━━━━━━━
[9/15] 正在发送给: 张三
```

**防封禁机制：**
- 🔄 每条消息间隔 5-10 秒（随机）
- ⏸️ 检测到 FloodWait 自动暂停
- 🛑 检测到 PeerFlood 立即停止
- 📊 实时进度显示

**完成后显示：**
```
✅ 群发完成！成功: 14, 失败: 1
```

---

### Tab 3: 📜 运行日志

```
📜 运行日志                     [🔄 刷新]
┌─────────────────────────────────────────┐
│ 🚀 程序启动中...                         │
│ 🔧 AI 接口地址已修正为: https://...     │
│ ✅ Userbot 启动成功！监听中...           │
│ 📩 收到私聊 [张三]: 你好                 │
│ 🤖 AI 正在思考...                        │
│ 📤 已回复: 你好！有什么可以帮你的？      │
└─────────────────────────────────────────┘
                [🗑️ 清空日志]
```

**功能：**
- 实时显示 `bot.log` 最新 100 行
- 点击"刷新"按钮查看最新日志
- 支持清空日志文件

---

## 🔧 技术原理

### 进程管理

#### 启动机器人
```python
# 使用 subprocess 后台运行
process = subprocess.Popen(
    ['python', 'main.py'],
    stdout=log_file,
    stderr=subprocess.STDOUT,
    creationflags=subprocess.CREATE_NEW_PROCESS_GROUP  # Windows
)

# 保存 PID 用于后续停止
with open('bot.pid', 'w') as f:
    f.write(str(process.pid))
```

#### 停止机器人
```python
# Windows: 使用 psutil
process = psutil.Process(pid)
process.terminate()

# Linux/Mac: 使用信号
os.kill(pid, signal.SIGTERM)
```

### 异步事件循环

Streamlit 是**同步**的，但 Telethon 是**异步**的。解决方案：

```python
# 在 Streamlit 中运行异步代码
loop = asyncio.new_event_loop()
asyncio.set_event_loop(loop)
result = loop.run_until_complete(async_function())
loop.close()
```

### 实时进度更新

```python
# 使用回调函数更新 Streamlit 组件
def update_progress(current, total, message):
    progress = current / total
    progress_bar.progress(progress)
    status_text.text(f"[{current}/{total}] {message}")

await send_broadcast_async(chats, message, update_progress)
```

---

## 📁 相关文件

### 自动生成的文件
- `bot.pid` - 机器人进程 PID
- `bot.log` - 机器人运行日志

### 配置文件
- `.env` - API 凭证
- `prompt.txt` - AI 人设
- `keywords.txt` - 触发关键词

### Session 文件
- `userbot_session.session` - Telegram 登录凭证

---

## 🎯 使用场景

### 场景 1：日常运维
```
1. 打开管理后台: streamlit run admin.py
2. 点击"启动"按钮
3. 查看日志确认运行正常
4. 需要调整话术时，在"话术配置"中修改
5. 下班时点击"停止"按钮
```

### 场景 2：紧急通知群发
```
1. 切换到"消息群发" Tab
2. 点击"加载分组"
3. 选择"客户群"
4. 输入通知内容
5. 预览目标列表
6. 确认后点击"开始群发"
7. 实时查看进度
```

### 场景 3：故障排查
```
1. 切换到"运行日志" Tab
2. 查看最新错误信息
3. 如果需要重启，点击"停止"后再"启动"
4. 观察日志确认问题是否解决
```

---

## ⚠️ 注意事项

- 隐私与安全：本仓库已忽略并从历史中移除了私密配置、会话文件、日志、数据库和大型二进制/压缩文件（例如 `.env`、`*.session`、`data/tenants/`、`release/`、`*.zip`、`*.exe`）。请不要将你的私人密钥、会话文件或租户数据提交到仓库。有关责任和上报安全问题，请参阅 SECURITY.md。

### 安全警告
1. **不要暴露端口**：默认只监听 localhost，不要修改为 0.0.0.0
2. **不要共享截图**：包含敏感信息（PID、路径等）
3. **定期检查日志**：及时发现异常行为

### 性能建议
1. **日志文件**：定期清空，避免过大
2. **群发频率**：建议每天不超过 50 条
3. **浏览器**：推荐使用 Chrome 或 Edge

### 常见问题

#### Q1: 点击"启动"后无反应？
**A:** 检查：
- `.env` 文件是否配置正确
- Python 路径是否正确
- 查看日志 Tab 是否有错误信息

#### Q2: 群发功能报错"未登录"？
**A:** 
- 先运行 `python main.py` 完成首次登录
- 确保 `userbot_session.session` 文件存在

#### Q3: 日志不更新？
**A:** 
- 点击"刷新"按钮
- 或者按 `R` 键刷新整个页面

#### Q4: 如何远程访问管理后台？
**A:** 
```bash
# 不推荐！有安全风险
streamlit run admin.py --server.address 0.0.0.0

# 推荐使用 SSH 端口转发
ssh -L 8501:localhost:8501 user@server
```

---

## 🎨 界面预览

### 亮点功能
- ✅ **响应式布局**：自适应屏幕大小
- ✅ **实时状态**：动态显示运行状态
- ✅ **颜色编码**：绿色=运行，红色=停止
- ✅ **Emoji 标识**：清晰的视觉提示
- ✅ **进度条**：群发时实时进度
- ✅ **错误提示**：友好的错误信息

---

## 🔄 更新记录

### v1.0.0 (当前版本)
- ✅ 基础功能完成
- ✅ 进程管理
- ✅ 话术配置
- ✅ 群发功能
- ✅ 日志监控

### 未来计划
- 🔜 数据统计（消息数、回复率）
- 🔜 定时任务（定时群发）
- 🔜 多账号管理
- 🔜 消息模板库
- 🔜 群发历史记录

---

## 📞 技术支持

如有问题，请检查：
1. 📖 本文档
2. 📜 运行日志
3. 🐛 GitHub Issues

---

**享受便捷的管理体验！** 🎉


