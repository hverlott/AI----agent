# 数据统计与分析指南

Version: 2.5.2
Last Updated: 2026-01-15

## 1. 功能概述
系统提供多维度的数据分析能力，包括宏观的商业运营数据（Business Dashboard）和微观的平台运行数据（Platform Stats）。
**v2.5.2 优化**: 引入数据库索引与查询优化，支持百万级会话数据的秒级检索与统计。

## 2. 数据看板介绍

### 2.1 商业化运营中心 (Business Ops)
侧边栏选择 **平台** -> **商业化运营** -> **数据看板**。

包含以下核心指标：
- **核心指标 (Core Metrics)**:
    - **今日活跃用户**: 24小时内有交互的去重用户数。
    - **API 调用量**: AI 接口的总调用次数。
    - **本月预估营收**: 基于订阅模型估算的收入。
- **成本分析**:
  - **总 Token 消耗**: 所有模型消耗的 Token 总和。
  - **总成本估算 ($)**: 根据模型单价计算的总成本。
  - **成本分布**: 按对话阶段 (Stage) 拆分的成本柱状图/饼图。
    - **字段说明**: 源于 `message_events` 表的 `stage` 与 `cost` 字段。
    - **前端实现**: `df_cost = pd.DataFrame(list(cost_by_stage.items()), columns=['Stage','Cost'])`，支持排序与筛选。
- **趋势分析**: 关键指标的 7 日/30 日走势图。

![商业化看板示意图]

### 2.2 平台运行统计 (Platform Stats)
侧边栏选择 **平台** -> **Telegram/WhatsApp** -> **统计 (Stats)**。

包含以下运维指标：
- **消息概览**: 总消息数、总回复数、成功/失败次数。
- **类型分布**: 私聊 vs 群聊 消息占比。
- **审核与兜底**:
    - **PASS**: 通过审核并发送的次数。
    - **FAIL**: 审核拦截次数。
    - **Fallback**: 触发兜底回复的次数。
- **运行时长**: 机器人连续在线时间。

![平台统计示意图]

## 3. 操作步骤

### 3.1 导出报表
目前支持通过截图或复制数据方式导出。Excel/CSV 导出功能将在后续版本上线。

### 3.2 指标计算口径
- **Token 与成本**: 聚合 LLM 使用量（Supervisor 决策 + 生成），以统一费率估算成本。
- **Stage 口径**: 每次回复按当前 `state.current_stage` 记录；如无阶段信息，展示为 `Unknown`。

### 3.2 重置统计
在平台统计页面底部，点击 **🗑️ 重置统计** 按钮，可清空当前累积的计数器（不影响历史日志）。

## 4. 常见问题 (FAQ)

*   **Q: 成本数据准确吗？**
    *   A: 成本是基于 Token 数量和预设单价（如 $0.03/1k tokens）估算的，仅供参考，实际账单请以 AI 服务商后台为准。
*   **Q: 为什么"今日活跃用户"数比实际少？**
    *   A: 仅统计与机器人产生**有效交互**（触发了回复）的用户。被静默过滤或未触发回复的消息不计入活跃。
*   **Q: 统计数据会保存多久？**
    *   A: 每日聚合数据永久保存（SQLite `daily_stats` 表），实时看板数据重启后可能会重置（取决于缓存策略）。
