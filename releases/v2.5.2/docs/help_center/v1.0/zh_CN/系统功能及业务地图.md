# 系统功能及业务地图

本文档详细梳理了 v2.5.2 版本管理后台的所有功能模块及其背后的深度业务逻辑链条，旨在帮助管理员和开发者快速理解系统全貌。

---

## 🟢 第一部分：系统功能清单

本清单完全对应管理后台左侧菜单栏的层级结构。

### 1. 🤖 AI 配置中心

#### AGNT AI 配置中心
*   **模型注册表**: 
    *   管理所有 AI 提供商 (DeepSeek, OpenAI, LocalAI)。
    *   配置 API Key、Base URL 和模型名称。
*   **会话链路绑定**: 
    *   将注册的模型绑定到具体的业务环节：
        *   **场控 (Supervisor)**: 负责意图识别与流程路由。
        *   **执行者 (Worker)**: 负责具体回复生成。
        *   **主审核 (Primary Audit)**: 负责初步合规检查。
        *   **副审核 (Secondary Audit)**: 负责深度安全审计。

#### AI 剧本配置
*   **流程编排**: 可视化定义对话状态机，包括节点 (Nodes) 和跳转规则 (Transitions)。
*   **人设管理**: 定义不同阶段的 AI 人设 (Persona)，如“专业客服”、“销售顾问”。
*   **配置导入/导出**: 支持 JSON 格式的剧本配置备份与迁移。

#### AI 场控中心
*   **会话监控**: 实时查看当前活跃用户的会话状态 (State)、记忆 (Memory) 和最近意图。
*   **人工干预**: 强制修改用户的当前阶段 (Stage) 或人设，甚至清除记忆重置会话。
*   **决策回放**: 查看 Supervisor 历史的路由决策日志，用于调试 Prompt 效果。

#### 技能中心
*   **技能库**: 管理可复用的 Prompt 模板或规则集（如“查询订单”、“退款流程”）。
*   **技能绑定**: 将技能挂载到特定的业务线或租户。

#### AI 学习中心
*   **数据标注**: 浏览历史对话，标记“高质量”或“垃圾”数据。
*   **微调导出**: 将标注好的数据批量导出为 JSONL 格式，用于模型微调 (Fine-tuning)。

---

### 2. 📱 平台配置

#### Telegram
*   **运行控制**: 启动、停止、重启 Telegram Bot 进程，查看 PID 和运行状态。
*   **账号切换**: 选择并加载不同的 `session` 文件进行登录。
*   **配置管理**: 修改 `config.txt` (白名单开关、私聊开关、知识库模式等)。
*   **消息广播**: 向所有白名单群组发送系统通知。
*   **日志分析**: 查看系统日志 (`system.log`) 和错误日志。

#### WhatsApp
*   **扫码登录**: 实时显示登录二维码 (QR Code)。
*   **状态监控**: 查看连接状态 (Connected/Disconnected)。
*   **参数配置**: 调整 WhatsApp 专用的 Prompt 和关键词。

---

### 3. 💼 业务管理

#### 商业化运营
*   **数据看板**: 统计活跃用户数 (DAU)、Token 总消耗量、预估成本。
*   **订阅管理**: 管理租户的订阅计划 (Free/Pro/Enterprise) 及过期时间。
*   **品牌设置**: 自定义管理后台的 Logo、名称和配色方案。

#### 账号管理
*   **社媒账号池**: 统一管理所有平台的登录账号信息 (Phone, API ID)。
*   **登录助手**: 提供 Telegram 验证码输入界面，自动生成并保存 Session 文件。

---

### 4. 📚 数据管理

#### 知识库管理
*   **文档入库**: 上传 PDF/TXT/MD 文件，自动进行文本分块 (Chunking)。
*   **条目编辑**: 手动修正切片后的内容、分类和标签。
*   **检索测试**: 模拟用户提问，验证知识库召回的准确性。

#### 合规与审计
*   **敏感词库**: 管理全局禁止的关键词 (Keywords)，支持正则匹配。
*   **审计日志**: 查看被拦截的违规内容记录及拦截原因。
*   **策略配置**: 设置审计的严格程度（Fail-Open/Fail-Closed）和重试次数。

---

### 5. 🛠️ 系统管理

#### 系统管理
*   **基础管理**: 创建新租户、管理管理员账号、IP 白名单设置。

#### 系统配置自动化
*   **安全配置**: `.env` 环境变量加密生成、Session 权限修复。
*   **路由配置**: API 网关路由规则配置。

#### 系统状态
*   **全链路监控**: 基于 Trace 日志分析各节点 (KB检索/AI生成/审核) 的成功率与延迟。

#### 测试用例集
*   **自动化测试**: UI 一键触发后端测试脚本 (冒烟测试、回归测试)，并查看报告。

---

## 🔵 第二部分：深度业务链清单

以下是核心功能的端到端业务逻辑流转分析，展示了数据如何在各个模块间流动。

### 🔗 链条一：AI 剧本编排与执行 (Orchestration Chain)

**场景**: 管理员修改了剧本，用户发送消息触发新流程。

1.  **UI 配置**: 管理员在 `AI剧本配置` 页面修改 Stage 跳转规则 -> 点击保存。
2.  **数据持久化**: 后端调用 `db.upsert_script_profile` -> 更新 SQLite `script_profiles` 表。
3.  **运行时加载**: 用户发送消息 -> Telegram Handler 触发 -> `SupervisorAgent` 从 DB 读取最新配置。
4.  **决策逻辑**: Supervisor 分析意图 -> 匹配 Transition 规则 -> 更新 `conversation_states` 表中的 `current_stage`。
5.  **执行生成**: `StageAgentRuntime` 根据新 Stage 的设定 -> 检索 KB -> 调用 LLM 生成回复。

### 🔗 链条二：多租户机器人启动 (Bot Lifecycle Chain)

**场景**: 管理员为“租户A”启动 Telegram 机器人。

1.  **环境准备**: 管理员在 `Telegram` 页面选择 Session -> 点击“启动”。
2.  **上下文隔离**: 后端读取 `data/tenants/租户A/config.txt` 和 `ai_providers.json`。
3.  **进程孵化**: 调用 `subprocess.Popen` -> 执行 `python -m src.modules.telegram.bot` (传入 `--tenant 租户A`)。
4.  **状态同步**: 写入 PID 到 `data/tenants/租户A/platforms/telegram/bot.pid`。
5.  **UI 反馈**: 页面轮询 PID 文件是否存在 -> 更新状态指示灯为 🟢 Running。

### 🔗 链条三：知识库 RAG 闭环 (RAG Chain)

**场景**: 上传一份产品手册 PDF 并被 AI 引用。

1.  **文件处理**: `知识库管理` 上传 PDF -> 保存至 `knowledge_base_files/` -> `pypdf` 解析提取文本。
2.  **索引构建**: 文本分块 -> 调用 `reindex_kb.py` 生成 Embedding -> 存入 `chroma/vectors.pkl`。
3.  **检索召回**: 用户提问 -> `engine.py` 优先使用 **向量相似度 (Cosine Similarity)** 检索 -> 失败则降级为关键词匹配。
4.  **生成增强**: 召回片段注入 System Prompt -> LLM 生成基于文档的回答。

### 🔗 链条四：双重审计拦截 (Audit Chain)

**场景**: AI 生成了一条包含敏感信息的回复。

1.  **生成后钩子**: `AuditManager` 捕获 LLM 的初步回复。
2.  **初审 (Primary)**: 关键词正则匹配 (KeywordManager) -> 命中 -> **直接拦截**。
3.  **复审 (Secondary)**: 若未命中关键词 -> 调用 `Auditor` (LLM) 进行语义审核 -> 判定 "FAIL"。
4.  **兜底处理**: 触发 `audit_fallback` -> 从缓存或配置中读取安全话术（如“我无法回答该问题”）。
5.  **日志审计**: 违规内容、原因、时间戳写入 `audit_logs` 表 -> 管理员在 `合规与审计` 页面可见。
