# 系统升级说明文档 (Upgrade Guide)

**适用版本**:
- v2.5.1 -> v2.5.2
- v2.x -> v2.5.2

**更新日期**: 2026-01-15

---

## 1. 版本更新摘要

本次升级包含以下核心变更：

### v2.5.2（相对 v2.5.1）
- **可视化升级**：
  - 🛠️ **技能中心 (Skill Center)**：新增可视化管理面板，支持实时开关与 JSON 配置。
  - 👁️ **剧本编辑器 (Stage Editor)**：新增流程图实时预览，直观展示节点逻辑。
- **业务增强**：
  - 🛡️ **内容过滤 (Content Filter)**：Telegram 平台新增高级过滤模块，支持关键词密度拦截。
- **架构升级**：
  - 🗄️ **数据库优先**：配置加载机制全面转向数据库，支持 PostgreSQL 扩展。
  - 🚀 **性能优化**：`message_events` 表新增索引，百万级数据查询秒级响应。

---

## 2. 升级方案 (Upgrade Strategy)

根据您的现状，请选择合适的升级路径：

### 🅰️ 自动升级（推荐，从 v2.5.1）
如果您正在运行 v2.5.1 版本，可直接使用内置的升级工具。

1.  **上传包**：在系统管理 -> 系统升级页面，上传 `SaaS-AI-System-v2.5.2.zip`。
2.  **执行升级**：点击升级按钮，系统将自动：
    - 备份当前环境
    - 替换核心代码
    - 执行数据库迁移脚本
3.  **重启**：升级完成后，手动或自动重启服务。

### 🅱️ 手动升级（通用）
适用于无法使用自动升级或跨大版本升级的场景。

#### 步骤 1: 数据备份
备份 `data/` 目录下的所有内容，特别是 `core.db` 和 `tenants/` 目录。

#### 步骤 2: 替换文件
解压升级包，覆盖以下目录/文件：
- `admin_multi.py`
- `src/` (全量覆盖)
- `docs/`
- `pack.py`

#### 步骤 3: 数据库迁移 (关键)
v2.5.2 引入了新的索引和配置存储方式，必须执行迁移脚本：

```bash
# 激活虚拟环境
source .venv/bin/activate  # Linux/Mac
.venv\Scripts\activate     # Windows

# 运行迁移脚本
python scripts/migrate_to_db.py
```

> **注意**：此脚本会将旧版 `config.txt` 中的配置迁移至数据库 `tenants` 表中。

#### 步骤 4: 重启服务
重启 `start_admin.bat` 和 `main.py`。

---

## 3. 全新部署方案 (Fresh Install)

如果您是新用户或希望重新部署：

1.  **解压**：将 `SaaS-AI-System-v2.5.2.zip` 解压至目标目录。
2.  **初始化**：
    - Windows: 双击运行 `install.bat`
    - Linux: 运行 `bash install.sh`
3.  **启动**：
    - 双击 `start_admin.bat` 进入管理后台。
    - 首次登录请使用默认账号或注册新租户。
4.  **配置**：
    - 进入 **系统设置**，检查数据库连接（默认 SQLite，无需配置）。
    - 进入 **Telegram 配置**，填入 Bot Token 并保存。

---

## 4. 验证升级 (Verification)

1.  **版本检查**：管理后台底部应显示 `v2.5.2`。
2.  **功能检查**：
    - 进入 **Telegram 配置**，确认能看到 **"🛡️ 内容过滤配置"** 面板。
    - 进入 **技能中心**，确认能看到可视化列表。
3.  **数据检查**：
    - 检查 **"📜 日志"**，确认无数据库报错。
    - 确认历史会话记录在 **AI 学习中心** 中可见。

---

## 5. 回滚方案 (Rollback)

若升级失败，请恢复备份：
1. 删除当前项目目录。
2. 还原备份的 `data/` 目录到 v2.5.1 版本文件夹。
3. 启动 v2.5.1 版本服务。

## 修订记录

| 版本号 | 更新日期 | 修改人 | 修改摘要 |
| :--- | :--- | :--- | :--- |
| v2.5.2 | 2026-01-15 | System Admin | 更新 v2.5.2 升级指南，增加数据库迁移步骤 |
