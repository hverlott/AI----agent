# SaaS AI System v2.5.2 交付说明

**交付版本**: v2.5.2  
**交付日期**: 2026-01-15  
**适用对象**: 业务方、运维、实施团队  

---

## 一、版本定位与整体价值

v2.5.2 是一次以「稳定运营」和「可持续演进」为目标的升级版本，核心围绕三件事：
- 配置与数据全面数据库化，支撑长周期可观测与可运营；
- 对话业务链路闭环，从触达、识别、应答到学习全部可追踪；
- 提供在线/离线升级能力，降低后续交付与运维成本。

---

## 二、新增功能清单

### 1. 智能升级能力

- **GitHub 在线升级**  
  - 后台新增「🚀 系统升级与维护」模块，可配置 GitHub 仓库地址；  
  - 一键检查远端 Release，支持在线查看版本说明、选择版本并触发安装；  
  - 自动完成压缩包下载、解压、版本目录落盘和启动脚本切换。

- **离线 Zip 包升级**  
  - 支持通过运维提供的 `SaaS-AI-System-vX.Y.Z.zip` 在服务器上完成覆盖式升级；  
  - 内置升级日志表 `upgrade_logs`，可记录版本来源、目标版本、备份路径与时间。

- **版本管理与回滚**  
  - 后台支持查看当前运行版本、本地已安装版本列表；  
  - 支持一键切换至旧版本（例如从 v2.5.2 回滚至 v2.5.1），极大降低升级风险。

### 2. 内容过滤与合规能力

- **Telegram 内容过滤模块**  
  - 面向 Telegram 渠道新增内容过滤配置项，支持：
    - 关键词密度检测（如高频“返利”“优惠”等）；
    - 触发拦截后不再进入 AI 生成链路，直接标记为 `filtered` 状态；
  - 拦截结果写入 `message_events` 表，支持后续统计与审计。

- **可视化配置面板**  
  - 在平台配置中提供内容过滤开关与规则配置入口；  
  - 与审核模块（Audit）协同工作，实现「过滤 → 审核 → 兜底」组合策略。

### 3. 技能中心（Skill Center）

- **统一的技能管理后台**  
  - 新增技能表 `skills`，支持按租户维度配置技能；  
  - UI 支持技能启用/禁用、描述维护、绑定到指定的 AI 配置（业务线）。

- **运行时生效（热重载）**  
  - 技能配置从数据库读取，变更后无需重启服务；  
  - 与会话编排（Supervisor / Stage）联动，实现「按业务线注入不同技能」。

### 4. 数据库与多实例支持

- **PostgreSQL 支持**  
  - 在保留 SQLite 的基础上，新增 PostgreSQL 驱动 `DatabaseManagerPG`；  
  - 通过环境变量 `DATABASE_URL` 自动识别并切换到云数据库实例；  
  - 支持向量扩展 `vector`，为后续向量检索和 RAG 能力预留空间。

- **统一配置中心**  
  - 系统配置、租户配置、技能配置、会话状态等全部进入数据库；  
  - 解决了之前 `config.txt` 等文件分散、无法审计的问题。

---

## 三、优化与改进清单

### 1. 性能与可观测性

- **消息流水表索引优化**  
  - 为 `message_events` 增加如下索引：
    - `idx_msg_tenant_time (tenant_id, timestamp DESC)`：加速最近会话查询；
    - `idx_msg_learning (tenant_id, is_learnable, is_junk)`：支撑 AI 学习中心的筛选；
    - `idx_msg_chat (chat_id, timestamp)`：按会话维度快速回放对话。
  - 在百万级消息数据下，查询耗时由秒级降至毫秒级。

- **升级日志与备份能力**  
  - 新增 `upgrade_logs`、`backup_all/restore_backup` 能力；  
  - 升级前可自动打包核心 DB、.env、Session 以及知识库文件夹，保障可回滚。

### 2. 安装包与交付体验

- **打包脚本重构（pack.py）**  
  - 自动包含 `src/` 源码、`scripts/` 迁移脚本、`docs/` 文档等必要目录；  
  - 过滤 `.env`、数据库文件、日志文件等环境敏感内容；  
  - 打包结果为规范命名的 `SaaS-AI-System-v2.5.2.zip`，便于对外交付与归档。

- **版本与文档同步**  
  - 后台标题、版本展示统一更新为 v2.5.2；  
  - 帮助中心中的版本历史、架构图、升级说明同步到当前版本。

---

## 四、业务链路闭环说明（v2.5.2 后）

以下以 Telegram 为例，说明从「用户触达」到「持续优化」的完整业务闭环：

1. **用户触达与消息接入**
   - 用户在 Telegram 发起消息，Bot 通过 Telethon 收到 `NewMessage` 事件；
   - 系统根据租户配置和白名单判断是否进入处理流程。

2. **前置过滤与合规**
   - 内容首先进入内容过滤模块（Content Filter）：  
     - 命中高危或垃圾特征 → 直接标记为 `filtered`，可选择静默丢弃或返回固定话术；  
     - 未命中 → 进入下一步 QA / KB / Orchestrator。

3. **业务决策与智能回复**
   - 优先命中 **QA 规则**：对高频问答进行快速回复，减少模型调用；  
   - 未命中 QA 时：
     - 当配置为「知识库优先 (KB_ONLY)」时，直接从知识库检索并作答；  
     - 当配置为「会话编排 (Orchestration)」时，由 Supervisor 选择合适的 Stage/Persona；  
     - 默认模式下，走通用 RAG 流程：向量检索 + 大模型生成。

4. **审核与兜底**
   - 生成的回复进入审核模块（Audit）：  
     - 审核通过：将结果返回给用户并写入消息流水；  
     - 审核不通过：触发兜底策略（固定安全话术、转人工提示等）。

5. **数据沉淀与学习**
   - 所有入出站消息被记录到 `message_events`，包含：
     - 对话内容、模型、Token 消耗、成本、阶段等信息；  
     - 是否可学习、是否垃圾、归属 AI 业务线等标签。
   - 管理员可在 **AI 学习中心** 中筛选、标记「可学习」数据，并导出为训练集。

6. **策略与技能闭环**
   - 通过技能中心对不同业务线配置差异化技能：  
     - 某租户可启用「售前问答」技能，另一租户启用「风控审核」技能；  
     - 技能可以绑定到具体的 AI 配置，实现“模型/Prompt/技能”一体化管理。  
   - 新增或调整的技能与规则立即生效，构成「配置 → 流量 → 学习 → 再配置」的持续优化闭环。

---

## 五、升级与兼容性说明

- **支持的升级路径**
  - 推荐路径：从 v2.5.1 通过 Zip 包或在线升级至 v2.5.2；  
  - 更早版本需要先升级至 v2.5.1，再按标准流程升级。

- **必须执行的动作**
  - 升级后，在新版本目录执行一次数据库迁移脚本：

```bash
python scripts/migrate_to_db.py
```

- **回滚策略**
  - 如遇重大问题，可通过后台版本管理或修改 `start.bat` 中的 `LATEST_VERSION` 快速回滚至旧版本；  
  - 搭配备份功能，可完整恢复核心数据库和关键配置。

---

## 六、交付物清单（供甲方验收）

- 源码与可执行环境：
  - `releases/v2.5.2/` 完整代码目录；
  - 标准安装包：`SaaS-AI-System-v2.5.2.zip`。
- 文档：
  - 《v2.5.2 交付说明》（本文档）；  
  - 《升级操作手册》：`docs/OPS_HANDOVER_v2.5.2.md`；  
  - 《系统升级说明文档》：`docs/UPGRADE_GUIDE.md`；  
  - 帮助中心：`docs/help_center/v1.0/zh_CN/*`。
- 数据库变更：
  - 新增/调整表结构：`system_configs`、`message_events` 索引、`skills`、`upgrade_logs` 等。

