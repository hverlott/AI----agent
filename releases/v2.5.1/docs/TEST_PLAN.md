# 系统升级与测试方案 (System Upgrade & Test Plan)

**Version**: 1.1  
**Date**: 2026-01-09  
**Author**: QA Team

---

## 1. 质量保障 (Quality Assurance)

### 1.1 测试策略
我们采用分层测试策略，确保本次 v2.3.0 升级在“登录权限”“多租户隔离”“AI学习中心”“技能中心”新增能力下的稳定性。

| 测试层级 | 测试内容 | 责任方 |
| :--- | :--- | :--- |
| **功能测试** | 验证系统登录、角色权限、租户隔离、学习/技能模块、Supervisor 监控与文档一致性 | QA / 开发 |
| **性能测试** | 验证日志加载性能 (Cache)、大数据量下的页面响应 | 开发 |
| **兼容测试** | 验证新旧配置文件的兼容性、不同浏览器的显示效果 | QA |
| **回归测试** | 确保 Telegram/WhatsApp 核心收发消息功能不受影响 | QA |

### 1.2 测试用例 (Test Cases)

#### A. 权限控制 (RBAC)
- [ ] **TC-001**: 打开后台，出现“系统登录”表单并可登录。
- [ ] **TC-002**: SuperAdmin 登录后可访问「🛠️ 系统管理」与「🛣️ API接口管理中心」。
- [ ] **TC-003**: BusinessAdmin 登录后租户ID为只读且不可访问 SuperAdmin 专属模块。
- [ ] **TC-004**: SuperAdmin 可在侧边栏修改租户ID并切换数据视图。
- [ ] **TC-005**: IP 白名单启用时，非白名单 IP 会被拒绝访问。

#### B. 多租户隔离 (SaaS Isolation)
- [ ] **TC-010**: 不同租户写入的指标与配置互不影响（参考自动化用例 `tests/test_saas_isolation.py`）。
- [ ] **TC-011**: 切换租户后，技能列表与学习数据按租户隔离。

#### C. AI学习中心
- [ ] **TC-020**: AI学习中心可按平台/方向/可学习/垃圾/绑定AI筛选数据。
- [ ] **TC-021**: 勾选记录后可批量标记（可学习/垃圾）、绑定AI与标签。
- [ ] **TC-022**: 导出 JSONL 成功并落盘到 `data/tenants/<tenant_id>/learning_exports/`。

#### D. Skills 技能中心
- [ ] **TC-030**: 新建技能、启用并保存后，技能列表可见。
- [ ] **TC-031**: 绑定 AI 业务线后，仅在匹配业务线中生效（无绑定为通用）。
- [ ] **TC-032**: 选择适用回复路径（kb_only/script_only/both）后，在对应路径注入生效。

#### E. Supervisor 监控台
- [ ] **TC-040**: 点击 `🔄 刷新会话列表` 按钮，应触发加载状态 (Spinner)。
- [ ] **TC-041**: 若数据库连接正常，应显示最新会话列表。
- [ ] **TC-042**: 若数据库断开，应显示错误提示，而不导致页面崩溃。

#### C. 系统性能
- [ ] **TC-050**: 打开 `Telegram > 日志` 面板，日志加载应在 1s 内完成 (利用 Cache)。
- [ ] **TC-051**: 连续切换 Tab，日志读取不应重复触发全量磁盘 IO。

### 1.3 回归测试 (Regression)
- [ ] **TC-030**: 发送 Telegram 消息，Bot 应正常回复。
- [ ] **TC-031**: 触发敏感词，Bot 应拦截或通过 (根据配置)。
- [ ] **TC-032**: 知识库检索功能正常。

---

## 2. 升级说明 (Upgrade Guide)

### 2.1 升级前准备
1. **备份数据**:
   - 备份 `platforms/telegram/config.txt`
   - 备份 `platforms/telegram/prompt.txt`
   - 备份数据库 `data/knowledge_base/db.json`
   - 备份日志目录 `platforms/telegram/logs/`
2. **停止服务**: 关闭正在运行的 `start_admin.bat` 和 `python main.py`。

### 2.2 升级步骤
1. **代码更新**: 拉取最新代码 (Git pull) 或覆盖补丁包。
2. **依赖检查**: 确认 `requirements.txt` 无新增依赖 (本次无)。
3. **配置文件**: 检查 `.env` 是否存在。
4. **启动服务**:
   - 运行 `start_admin.bat` 启动新版后台。
   - 运行 `python main.py` 启动 Bot。

### 2.3 验证升级
- 登录后台，确认出现系统登录且登录后显示“角色/租户ID”。
- 进入 `Supervisor` 面板，测试刷新按钮。
- 发送一条测试消息给 Bot，确认回复正常。

## 修订记录

| 版本号 | 更新日期 | 修改人 | 修改摘要 |
| :--- | :--- | :--- | :--- |
| 1.1 | 2026-01-09 | Tech Writer | 更新为 v2.3.0 的登录/租户/学习/技能测试项 |

### 2.4 回滚方案 (Rollback)
若升级后出现严重故障 (Sev 1/2)，执行回滚：
1. 停止所有服务。
2. 将代码回退至上一版本 (Git checkout <tag>)。
3. 恢复备份的配置文件 (如果被破坏)。
4. 重启服务并验证。

---

## 3. 性能分析报告 (Performance Analysis)

### 3.1 瓶颈识别
- **问题**: `admin_multi.py` 中的 `_read_trace_jsonl` 在每次页面刷新时都会完整读取日志文件，随着日志增大，IO 开销显著。
- **影响**: 页面加载卡顿，磁盘 IO 飙升。

### 3.2 优化措施
- **Cache**: 引入 `st.cache_data(ttl=2)` 对日志读取进行缓存。
- **效果**: 
  - 相同日志文件在 2秒内只会读取一次。
  - 页面刷新速度提升，IO 操作减少 90% 以上 (高频刷新场景)。

### 3.3 验证结果
- **测试**: 模拟 10MB 日志文件，连续刷新 10 次。
- **结果**: 首次加载耗时 ~200ms，后续 9 次耗时 <5ms (命中缓存)。
