# Telegram/Multi-Platform AI Bot 系统产品需求文档 (PRD)

| 文档版本 | 修改日期 | 修改人 | 备注 |
| :--- | :--- | :--- | :--- |
| v1.1 | 2026-01-08 | AI Assistant | 增加智能化架构与协作机制详解 |
| v1.0 | 2026-01-08 | AI Assistant | 初始版本创建 |

---

## 1. 项目背景与目标 (Background & Objectives)

### 1.1 背景
现在做 Telegram/WhatsApp 业务，最大的痛点就是**回消息**。
客服每天面对海量咨询，大部分都是重复的（比如“怎么充值”、“规则是什么”），纯靠人工回，不仅累，还容易出错。而且人需要睡觉，夜间客户发消息没人回，很容易流失。
我们需要一个既能用来**学习研究 AI 技术**，又能**真正上岗干活**的系统。它不能只是个“聊天玩具”，而要是能解决实际运营痛点的“超级员工”。

### 1.2 目标
打造一套**简单好用、能落地**的 AI 智能客服系统。

*   **实在减负**：把 80% 那些重复的、枯燥的问答交给 AI，让人腾出手来处理真正重要、复杂的单子。
*   **随时待命**：不管是半夜还是周末，客户发消息立马能回，不让客户干等，服务不打烊。
*   **安全靠谱**：AI 毕竟是机器，我们得有机制管着它（双重风控），保证它不乱说话，在实际运营里敢用、放心用。
*   **实战导向**：不仅是聊聊天，还能引导客户办事（比如查规则、开户），真正把流量变现，提升运营效率。

---

## 2. 智能化架构与协作机制 (Intelligence & Collaboration)

本系统不仅仅是一个简单的问答机器人，而是一个由 **多个专用智能体 (Agents)** 和 **底层 AI 模型 (LLM)** 协同工作的复杂系统。

### 2.1 智能分层定义

| 层级 | 名称 | 定义 | 职责 | 智能程度 |
| :--- | :--- | :--- | :--- | :--- |
| **L0** | **基础 AI (Base AI)** | 底层大语言模型 (LLM) | 提供纯粹的语义理解、文本生成和逻辑推理能力。不具备记忆和业务状态。 | ★★★☆☆ (纯智力) |
| **L1** | **功能智能体 (Worker Agents)** | 拥有特定人设和任务的 AI | 结合了 **RAG 知识库** + **特定 Prompt**，负责执行具体的业务动作（如回答售后问题、计算报价）。 | ★★★★☆ (智力+技能) |
| **L2** | **管理智能体 (Manager Agents)** | 具备状态管理与决策能力的 AI | 负责任务分发、流程监控、质量审计。它们指挥 L1 智能体工作。 | ★★★★★ (智力+管理) |

### 2.2 智能体协作矩阵 (Agent Collaboration Matrix)

系统通过以下智能体的分工协作，实现从“理解”到“执行”再到“风控”的闭环：

| 智能体名称 | 类型 | 核心职责 | 协作方式 (Handshake) | 业务逻辑归属 |
| :--- | :--- | :--- | :--- | :--- |
| **Router Agent**<br>(路由智能体) | Manager | **意图识别与分发**<br>判断用户是闲聊、咨询、投诉还是需要人工。 | 接收用户消息 -> 分析意图 -> 唤醒对应的 Supervisor 或 Worker Agent。 | `main.py`<br>消息入口分流 |
| **Supervisor Agent**<br>(流程主管) | Manager | **状态机管理 (SOP)**<br>维护多轮对话的状态 (Stage)，决定流程是否推进。 | 接收 Router 指令 -> **分析当前进度** (调用 AI) -> 指派 Worker Agent 生成回复 -> 更新状态槽位 (Slots)。 | `supervisor_agent.py`<br>复杂业务流转 |
| **Worker Agents**<br>(执行专员) | Worker | **具体任务执行**<br>根据 Supervisor 的指令，生成具体的回复内容。 | 接收 Supervisor 任务 -> **检索知识库 (RAG)** -> 生成 Draft Reply -> 提交给 Auditor。 | `stage_agent_runtime.py`<br>话术生成、知识调用 |
| **Auditor Agent**<br>(风控官) | Manager | **双重审计**<br>对 Worker 生成的回复进行合规性审查。 | 接收 Draft Reply -> **语义审查** (调用 AI) -> PASS (放行) / FAIL (驳回并建议修改)。 | `audit_manager.py`<br>`auditor.py`<br>安全合规 |

### 2.3 协作流程示例：处理“游戏 API 接入与规则咨询”

1.  **用户输入**：“Jackpot 是怎么累计的？玩家中奖了怎么算？”
2.  **Router Agent**：
    *   分析意图：识别为“业务咨询 - 游戏规则/结算”。
    *   决策：转交给 **Support Worker Agent** (技术支持智能体)。
3.  **Support Worker Agent**：
    *   动作：调用 RAG 检索知识库 (匹配到 `QA-002` 等相关条目)。
    *   生成：生成回复草稿“Jackpot 在投注时收取 0.3% 进行累计。当玩家中 Jackpot 时，我们会将金额转给贵方。关于结算，我们可以支持多种模式，例如由贵平台自己结算，不涉及我方交收。”
    *   提交：发送给 Auditor。
4.  **Auditor Agent**：
    *   审查：检查是否包含违规财务承诺或敏感词。
    *   结果：PASS。
5.  **系统**：将回复发送给用户。

若用户进一步询问：“那怎么开通免转钱包？”，**Router** 可能会识别出流程意图，转交 **Supervisor Agent** 启动“接入引导 SOP”，引导用户提供 32 位 Key 并完成配置。

---

## 3. 核心功能模块 (Core Functional Modules)

### 3.1 多平台消息接入中心
**功能目的**：统一管理不同社交渠道的消息交互，实现“一次配置，多端运行”。
*   **多租户与多账号支持**：支持单系统承载多个独立业务方（租户），且每个租户可管理多套 API 凭证与账号会话。
*   **Telegram 接入**：支持私聊、群聊（含白名单/黑名单）、频道管理。
*   **WhatsApp 接入**：支持基于 Web 协议的自动化消息收发。
*   **消息路由**：根据来源平台和消息类型（文本、图片、文件）自动分发至 Router Agent。

### 3.2 智能对话引擎 (RAG + LLM)
**功能目的**：赋予机器人“理解”与“思考”的能力。
*   **检索增强生成 (RAG)**：**Worker Agents** 的核心工具，支持混合检索（关键词匹配 + 语义向量检索）。
*   **多轮对话上下文**：由 **Supervisor Agent** 维护，支持跨天、跨会话的记忆保持。
*   **AI 人设配置**：支持为不同的 Worker Agent 配置不同的人设（如销售热情、客服严谨）。

### 3.3 知识库管理系统 (Knowledge Base)
**功能目的**：作为 AI 的“大脑”，存储企业私有业务知识。
*   **多格式导入**：支持 PDF, Word, Excel, TXT, Markdown。
*   **可视化管理**：增删改查、标签管理。
*   **检索测试**：用于验证 **Base AI** 的检索准确性。

### 3.4 风控与审计系统 (Risk Control & Audit)
**功能目的**：确保 AI 输出内容的安全性。
*   **本地审计 (Level 1)**：正则/关键词拦截，由系统规则引擎处理。
*   **AI 审计 (Level 2)**：由 **Auditor Agent** 执行，使用独立的 Prompt 对回复进行语义审查。
*   **人工接管 (Handoff)**：当 **Router Agent** 识别到“转人工”意图时触发。

### 3.5 智能体编排 (Agent Orchestration)
**功能目的**：处理复杂的业务流程。
*   **SOP 状态机**：定义标准作业程序，**Supervisor Agent** 依据此逻辑推动业务进展。
*   **任务型 Agent**：集成销售、技术支持等专有角色。

### 3.6 营销与群发系统 (Broadcast)
**功能目的**：主动触达客户。
*   **分组群发**：基于 Telegram 分组。
*   **安全发送**：防封控策略。

### 3.7 数据分析看板 (Analytics Dashboard)
**功能目的**：量化系统价值。
*   **核心指标**：DAU、API 调用、Token 消耗。
*   **成本分析**：按 Agent 统计 Token 消耗。

---

## 4. 解决的业务场景 (Business Scenarios)

### 场景一：7x24 小时智能客服
*   **协作模式**：Router -> Support Worker Agent -> Auditor。
*   **智能点**：自动识别问题类型，精准调用知识库回答，无需人工干预。

### 场景二：复杂业务流程引导 (如 KYC 认证)
*   **协作模式**：Router -> Supervisor (SOP管理) -> Guide Worker Agent -> Auditor。
*   **智能点**：Supervisor 记忆用户已完成的步骤 (Slot Filling)，即使用户打断或闲聊，也能自动拉回主流程。

### 场景三：社群合规与环境净化
*   **协作模式**：Router (群消息监听) -> Auditor Agent (直接审查)。
*   **智能点**：Auditor Agent 理解语境中的恶意（如隐晦的广告或诈骗），而不仅仅是匹配关键词。

---

## 5. 用户角色 (User Roles)

| 角色 | 职责描述 |
| :--- | :--- |
| **超级管理员 (Admin)** | 系统配置、API 管理。 |
| **运营人员 (Operator)** | 知识库维护、SOP 流程配置、群发任务。 |
| **最终用户 (End User)** | C 端客户。 |

---

## 6. 系统非功能需求 (Non-functional Requirements)

*   **高可用性**：多实例部署。
*   **可扩展性**：支持接入更多类型的 Worker Agent。
*   **数据安全**：API Key 加密，日志脱敏。
