# 🎛️ 功能开关说明

## 📋 功能概述

新增的功能开关可以让你实时控制机器人的回复行为，无需重启程序。

### 两个核心开关

1. **私聊消息回复开关** (`PRIVATE_REPLY`)
   - 开启：自动回复所有私聊消息
   - 关闭：不回复任何私聊消息

2. **群聊消息回复开关** (`GROUP_REPLY`)
   - 开启：根据关键词和 @ 触发回复
   - 关闭：不回复任何群聊消息

---

## ⚙️ 配置方式

### 方式 1：通过 Web 管理后台（推荐）

1. 启动管理后台：
```bash
streamlit run admin.py
```

2. 切换到 **"🧠 话术配置"** Tab

3. 在底部找到 **"⚙️ 功能开关"** 部分

4. 使用开关按钮控制：
   ```
   私聊消息回复    [✓ 开启私聊自动回复]
   群聊消息回复    [✓ 开启群聊自动回复]
   ```

5. 点击 **"💾 保存开关设置"** 按钮

6. ✨ 立即生效！

### 方式 2：直接编辑配置文件

编辑 `config.txt` 文件：

```bash
# Windows
notepad config.txt

# Linux/Mac
nano config.txt
```

修改配置：
```ini
# 个人消息回复开关
PRIVATE_REPLY=on   # on=开启, off=关闭

# 群消息回复开关
GROUP_REPLY=on     # on=开启, off=关闭
```

保存后立即生效！

---

## 🎯 使用场景

### 场景 1：临时关闭自动回复

**情况：** 你需要自己处理消息，不想 AI 干扰

**操作：**
```
关闭私聊回复：PRIVATE_REPLY=off
关闭群聊回复：GROUP_REPLY=off
```

**效果：**
- 机器人仍在运行
- 但不会自动回复任何消息
- 随时可以重新开启

### 场景 2：只回复私聊

**情况：** 只想在私聊中使用 AI，群聊自己处理

**操作：**
```
开启私聊回复：PRIVATE_REPLY=on
关闭群聊回复：GROUP_REPLY=off
```

**效果：**
- 私聊消息自动回复
- 群聊消息不回复（即使被 @ 或触发关键词）

### 场景 3：只回复群聊

**情况：** 只在特定群聊中使用，私聊自己回复

**操作：**
```
关闭私聊回复：PRIVATE_REPLY=off
开启群聊回复：GROUP_REPLY=on
```

**效果：**
- 私聊消息不回复
- 群聊根据关键词和 @ 回复

### 场景 4：工作时间/非工作时间

**白天（工作时间）：**
```
PRIVATE_REPLY=off  # 自己处理
GROUP_REPLY=off
```

**晚上（非工作时间）：**
```
PRIVATE_REPLY=on   # AI 托管
GROUP_REPLY=on
```

---

## 📊 状态说明

### 开启状态
```
✅ 当前状态：开启
```
- 机器人会根据配置回复消息
- 日志中显示：`📩 收到消息...`

### 关闭状态
```
🔴 当前状态：关闭
```
- 机器人忽略消息
- 日志中显示：`🔕 回复已关闭，忽略消息...`

---

## 🔍 日志示例

### 私聊回复开启
```
📩 收到私聊 [张三]: 你好
🤖 AI 正在思考...
📤 已回复: 你好！有什么可以帮你的？
```

### 私聊回复关闭
```
🔕 私聊回复已关闭，忽略消息 [张三]: 你好
```

### 群聊回复开启
```
📩 群聊触发关键词 [帮我] [李四]: 谁能帮我一下？
🤖 AI 正在思考...
📤 已回复: 我来帮你！有什么问题吗？
```

### 群聊回复关闭
```
🔕 群聊回复已关闭，忽略消息 [李四]: 谁能帮我一下？
```

---

## ⚡ 实时生效

### 如何验证？

1. 修改开关配置
2. 保存文件
3. 发送测试消息
4. 查看运行日志

**无需重启机器人！**

---

## 🛠️ 技术原理

### 热更新机制

```python
# 每次收到消息时重新读取配置
config = load_config()

# 检查开关
if event.is_private and not config['PRIVATE_REPLY']:
    print("🔕 私聊回复已关闭")
    return

if event.is_group and not config['GROUP_REPLY']:
    print("🔕 群聊回复已关闭")
    return
```

### 配置文件格式

```ini
# 注释行（以 # 开头）
KEY=VALUE

# 示例
PRIVATE_REPLY=on
GROUP_REPLY=off
```

**解析规则：**
- `on` → `True` (开启)
- `off` → `False` (关闭)
- 不区分大小写
- 忽略空行和注释

---

## 🔧 高级配置

### config.txt 完整示例

```ini
# ========================================
# Telegram AI Bot - 功能开关配置
# ========================================

# 个人消息回复开关
PRIVATE_REPLY=on

# 群消息回复开关
GROUP_REPLY=on

# ========================================
# 其他配置（预留扩展）
# ========================================

# 是否显示"正在输入"状态
# SHOW_TYPING=on

# 是否记录聊天日志
# LOG_MESSAGES=on

# 最大回复长度
# MAX_REPLY_LENGTH=500

# 回复延迟（秒）
# REPLY_DELAY=2
```

### 未来扩展

可以添加更多开关：
- ✅ 显示输入状态
- ✅ 消息日志记录
- ✅ 自动翻译
- ✅ 敏感词过滤
- ✅ 定时任务

---

## ❓ 常见问题

### Q1: 修改后没有生效？

**A:** 
1. 检查文件格式是否正确
2. 确保保存了文件
3. 查看日志确认是否读取新配置
4. 如果使用管理后台，点击"保存"按钮

### Q2: 可以定时切换开关吗？

**A:** 
可以！使用系统定时任务：

**Windows (任务计划程序):**
```powershell
# 创建脚本 switch-config.ps1
$content = @"
PRIVATE_REPLY=off
GROUP_REPLY=off
"@
Set-Content config.txt $content
```

**Linux (cron):**
```bash
# 每天 18:00 开启
0 18 * * * echo "PRIVATE_REPLY=on\nGROUP_REPLY=on" > /path/to/config.txt

# 每天 9:00 关闭
0 9 * * * echo "PRIVATE_REPLY=off\nGROUP_REPLY=off" > /path/to/config.txt
```

### Q3: 关闭后机器人还在运行吗？

**A:** 
是的！机器人仍在运行，只是：
- 不回复消息
- 仍然接收消息
- 可以随时开启

### Q4: 可以只在特定群开启吗？

**A:** 
当前版本是全局开关。如果需要更细粒度控制，可以：
1. 使用关键词配置（只在有特定关键词的群回复）
2. 扩展 config.txt 添加群组白名单

---

## 📝 更新记录

### v1.3.0 (2024-12-18)
- ✅ 新增私聊消息回复开关
- ✅ 新增群聊消息回复开关
- ✅ Web 管理后台集成开关控制
- ✅ 支持热更新（无需重启）
- ✅ 日志显示开关状态

---

## 🎉 总结

功能开关让你能够：
- ✅ 灵活控制机器人行为
- ✅ 实时调整无需重启
- ✅ 适应不同使用场景
- ✅ 通过 Web 界面轻松管理

**享受更灵活的机器人控制！** 🚀


